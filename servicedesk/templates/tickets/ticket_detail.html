{% extends 'base.html' %}

{% block content %}
<!-- Заголовок с кнопками действий -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Обращение #{{ ticket.id }}</h1>
    <div>
        {% if ticket.status == 'new' %}
            <a href="{% url 'take_ticket' ticket.id %}" class="btn btn-warning">
                Взять в работу
            </a>
        {% elif ticket.status == 'in_progress' %}
            <a href="{% url 'close_ticket' ticket.id %}" class="btn btn-success">
                Закрыть обращение
            </a>
        {% endif %}
    </div>
</div>

<!-- Информация об обращении -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">{{ ticket.subject }}</h5>
        <p><strong>Email:</strong> {{ ticket.user_email }}</p>
        <p><strong>Статус:</strong> 
            <span class="badge 
                {% if ticket.status == 'new' %}bg-danger
                {% elif ticket.status == 'in_progress' %}bg-warning
                {% else %}bg-success{% endif %}">
                {{ ticket.get_status_display }}
            </span>
        </p>
        <p><strong>Назначено:</strong> 
            {% if ticket.assigned_to %}
                {{ ticket.assigned_to.username }}
            {% else %}
                <span class="text-muted">Не назначено</span>
            {% endif %}
        </p>
    </div>
</div>

<!-- История сообщений -->
<h3>История переписки</h3>
{% for message in messages %}
<div class="card mb-2 {% if message.is_from_user %}border-primary{% else %}border-success{% endif %}">
    <div class="card-body">
        <div class="d-flex justify-content-between">
            <strong>
                {% if message.is_from_user %}
                    Пользователь
                {% else %}
                    {{ message.sender.username }}
                {% endif %}
            </strong>
            <small class="text-muted">{{ message.created_at|date:"d.m.Y H:i" }}</small>
        </div>
        <p class="card-text mt-2">{{ message.text }}</p>
    </div>
</div>
{% endfor %}

<!-- Форма для ответа -->
{% if ticket.status != 'closed' %}
<div class="card mt-4">
    <div class="card-header">
        <h5>Ответить пользователю</h5>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            <div class="mb-3">
                {{ form.text }}
            </div>
            <button type="submit" class="btn btn-primary">Отправить ответ</button>
        </form>
    </div>
</div>
{% endif %}

<!-- Кнопка назад -->
<div class="mt-3">
    <a href="{% url 'ticket_list' %}" class="btn btn-secondary">← Назад к списку</a>
</div>
{% endblock %}